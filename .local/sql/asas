CREATE OR REPLACE FUNCTION criartransacao(
    IN idcliente integer,
    IN valor integer,
    IN descricao varchar(10)
) RETURNS TABLE (saldo integer, limite integer) AS $$
DECLARE
    clienteencontrado cliente%rowtype;
    ret RECORD;
BEGIN
    SELECT * FROM cliente INTO clienteencontrado WHERE id = idcliente;

    IF not found THEN
        --raise notice'Id do Cliente % não encontrado.', idcliente;
       return query select -1, CAST(NULL AS integer);
       return;
    END IF;

    --raise notice'Criando transacao para cliente %.', idcliente;
    INSERT INTO transacao (valor, descricao, realizadaem, idcliente)
    VALUES (valor, descricao, now() at time zone 'utc', idcliente);
    UPDATE cliente
    SET saldo = cliente.saldo + valor
    WHERE id = idcliente AND (valor > 0 OR cliente.saldo + valor >= cliente.limite)
    RETURNING cliente.saldo, cliente.limite
        INTO ret;
    raise notice'Ret: %', ret;
    IF ret.limite is NULL THEN
        --raise notice'Id do Cliente % não encontrado.', idcliente;
        return query select -2, CAST(NULL AS integer);
        return;
    END IF;
    RETURN QUERY select ret.saldo, ret.limite;
END;$$ LANGUAGE plpgsql;
